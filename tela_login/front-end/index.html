<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>Meu Compromisso | Cadastro</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    body {
      min-height: 100vh;
      background: #f5f6fa;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .card { border-radius: 12px; }
    h4, h5 { font-weight: 600; }
  </style>
</head>

<body>
  <div class="container">
    <div class="row justify-content-center">

      <!-- FORM -->
      <div class="col-md-6 col-lg-5">
        <div class="card shadow-sm mb-4">
          <div class="card-body p-4">
            <h4 class="text-center mb-4">Meu Compromisso</h4>

            <form id="login-form" novalidate>
              <div class="mb-3">
                <label for="login" class="form-label">Login</label>
                <input type="text" class="form-control" id="login" placeholder="Seu login (ex: patric.cp)"
                  maxlength="30" required />
              </div>

              <div class="mb-3">
                <label for="nome" class="form-label">Nome</label>
                <input type="text" class="form-control" id="nome" placeholder="Seu nome completo" maxlength="50"
                  required />
              </div>

              <div class="mb-3">
                <label for="email" class="form-label">E-mail</label>
                <input type="email" class="form-control" id="email" placeholder="seuemail@email.com" maxlength="50"
                  required />
              </div>

              <div class="mb-3">
                <label for="telefone" class="form-label">Telefone</label>
                <input type="tel" class="form-control" id="telefone" placeholder="(00) 00000-0000" maxlength="15"
                  required />
              </div>

              <div class="mb-3" id="senha-wrap">
                <label for="senha" class="form-label">Senha</label>
                <input type="password" class="form-control" id="senha" placeholder="••••••••" maxlength="50" required />
              </div>

              <button type="submit" class="btn btn-dark w-100" id="save-btn">Cadastrar</button>

              <button type="button" class="btn btn-outline-secondary w-100 mt-2 d-none" id="cancel-btn">
                Cancelar edição
              </button>
            </form>

            <div class="text-center mt-3">
              <small class="text-muted">© 2025 Meu Compromisso</small>
            </div>
          </div>
        </div>
      </div>

      <!-- TABLE -->
      <div class="col-md-8 col-lg-7">
        <div class="card shadow-sm">
          <div class="card-body p-4">
            <h5 class="mb-3">Usuários Cadastrados</h5>
            <div class="table-responsive">
              <table class="table table-striped" id="usuarios-table">
                <thead class="table-dark">
                  <tr>
                    <th>#</th>
                    <th>Nome</th>
                    <th>E-mail</th>
                    <th>Login</th>
                    <th>Telefone</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API = 'http://localhost:3001';

    let editMode = false;
    let editId = null;

    async function parseJsonSafe(res) {
      const contentType = res.headers.get('content-type') || '';
      const txt = await res.text();

      if (!res.ok) throw new Error(`HTTP ${res.status}: ${txt}`);
      if (!contentType.includes('application/json')) {
        throw new Error(`Resposta não é JSON. Início: ${txt.slice(0, 80)}...`);
      }
      return JSON.parse(txt);
    }

    function normalizeNetworkError(err) {
      const msg = (err && err.message) ? err.message : String(err);
      if (msg.includes('Failed to fetch') || msg.includes('NetworkError')) {
        return 'Servidor fora do ar';
      }
      return msg;
    }

    function setEditMode(on, usuario = null) {
      editMode = on;

      const saveBtn = document.getElementById('save-btn');
      const cancelBtn = document.getElementById('cancel-btn');
      const senhaWrap = document.getElementById('senha-wrap');
      const senhaInput = document.getElementById('senha');

      if (on) {
        editId = usuario.id_cliente;

        document.getElementById('login').value = usuario.login_usuario ?? '';
        document.getElementById('nome').value = usuario.nome_cliente ?? '';
        document.getElementById('email').value = usuario.email_cliente ?? '';
        document.getElementById('telefone').value = usuario.telefone ?? '';

        // esconde senha em edição
        senhaWrap.classList.add('d-none');
        senhaInput.required = false;
        senhaInput.value = '';

        saveBtn.textContent = 'Salvar alteração';
        cancelBtn.classList.remove('d-none');
      } else {
        editId = null;

        document.getElementById('login-form').reset();

        senhaWrap.classList.remove('d-none');
        senhaInput.required = true;

        saveBtn.textContent = 'Cadastrar';
        cancelBtn.classList.add('d-none');
      }
    }

    document.getElementById('cancel-btn').addEventListener('click', () => setEditMode(false));

    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const form = document.getElementById('login-form');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      try {
        if (!editMode) {
          const payload = {
            login_usuario: document.getElementById('login').value.trim(),
            nome_cliente: document.getElementById('nome').value.trim(),
            email_cliente: document.getElementById('email').value.trim(),
            telefone: document.getElementById('telefone').value.trim(),
            senha: document.getElementById('senha').value
          };

          const res = await fetch(`${API}/usuarios`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const data = await parseJsonSafe(res);
          alert(data.mensagem || 'Cadastrado com sucesso');

          setEditMode(false);
          carregarUsuarios();

        } else {
          const payload = {
            login_usuario: document.getElementById('login').value.trim(),
            nome_cliente: document.getElementById('nome').value.trim(),
            email_cliente: document.getElementById('email').value.trim(),
            telefone: document.getElementById('telefone').value.trim()
          };

          const res = await fetch(`${API}/usuarios/${editId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const data = await parseJsonSafe(res);
          alert(data.mensagem || 'Atualizado com sucesso');

          setEditMode(false);
          carregarUsuarios();
        }
      } catch (err) {
        console.error(err);
        alert(normalizeNetworkError(err));
      }
    });

    async function carregarUsuarios() {
      try {
        const res = await fetch(`${API}/usuarios`);
        const usuarios = await parseJsonSafe(res);

        const tbody = document.querySelector('#usuarios-table tbody');
        tbody.innerHTML = '';

        usuarios.forEach(u => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${u.id_cliente}</td>
            <td>${u.nome_cliente ?? ''}</td>
            <td>${u.email_cliente ?? ''}</td>
            <td>${u.login_usuario ?? ''}</td>
            <td>${u.telefone ?? ''}</td>
            <td class="d-flex gap-2">
              <button class="btn btn-sm btn-primary" onclick="editarUsuario(${u.id_cliente})">Editar</button>
              <button class="btn btn-sm btn-danger" onclick="excluirUsuario(${u.id_cliente})">Excluir</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        window.__usuariosCache = usuarios;
      } catch (err) {
        console.error(err);
        alert(normalizeNetworkError(err));
      }
    }

    function editarUsuario(id) {
      const usuarios = window.__usuariosCache || [];
      const usuario = usuarios.find(x => x.id_cliente === id);

      if (!usuario) {
        alert('Usuário não encontrado');
        return;
      }

      setEditMode(true, usuario);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function excluirUsuario(id) {
      if (!confirm('Tem certeza que deseja excluir este usuário?')) return;

      try {
        const res = await fetch(`${API}/usuarios/${id}`, { method: 'DELETE' });
        const data = await parseJsonSafe(res);
        alert(data.mensagem || 'Excluído com sucesso');
        carregarUsuarios();
      } catch (err) {
        console.error(err);
        alert(normalizeNetworkError(err));
      }
    }

    window.editarUsuario = editarUsuario;
    window.excluirUsuario = excluirUsuario;

    window.addEventListener('load', carregarUsuarios);
  </script>
</body>

</html>
